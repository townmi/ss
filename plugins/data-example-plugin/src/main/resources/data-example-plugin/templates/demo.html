<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é«˜çº§æŸ¥è¯¢ç¤ºä¾‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
    }

    .demo-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .demo-section h2 {
      margin-top: 0;
      color: #4a90e2;
    }

    .code-example {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      overflow-x: auto;
    }

    pre {
      margin: 0;
      font-family: "Consolas", "Monaco", monospace;
      font-size: 14px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.2s;
      font-size: 14px;
      margin-right: 10px;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .btn-primary {
      background-color: #4a90e2;
      color: white;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #4a90e2;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .result-box {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-box pre {
      margin: 0;
      white-space: pre-wrap;
    }

    .query-builder {
      margin: 15px 0;
    }

    .query-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .query-row select,
    .query-row input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .query-row select {
      width: 150px;
    }

    .query-row input {
      flex: 1;
    }

    .tips {
      background-color: #e8f4fd;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin: 15px 0;
    }

    .tips h3 {
      margin-top: 0;
      color: #357abd;
    }

    .tips ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container">
    <a href="/page/data-example/" class="back-link">â† è¿”å›ç¤ºä¾‹åˆ—è¡¨</a>
    <h1>ğŸ” é«˜çº§æŸ¥è¯¢ç¤ºä¾‹</h1>

    <div class="demo-section">
      <h2>1. ä½¿ç”¨ QueryCriteria è¿›è¡ŒæŸ¥è¯¢</h2>
      <p>QueryCriteria æä¾›äº†æµç•…çš„ API æ¥æ„å»ºå¤æ‚æŸ¥è¯¢æ¡ä»¶ã€‚</p>

      <div class="code-example">
        <pre><code>// æŸ¥è¯¢æ´»è·ƒçš„ç®¡ç†å‘˜ç”¨æˆ·
List&lt;User&gt; activeAdmins = userRepository.findBy(
    QueryCriteria.&lt;User&gt;create()
        .eq("role", "admin")
        .eq("active", true)
        .orderBy("username", true)
);</code></pre>
      </div>

      <button class="btn btn-primary" onclick="queryActiveAdmins()">è¿è¡ŒæŸ¥è¯¢</button>
      <div id="result1" class="result-box" style="display: none;">
        <pre></pre>
      </div>
    </div>

    <div class="demo-section">
      <h2>2. å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢</h2>
      <p>æ”¯æŒå¤šç§æŸ¥è¯¢æ“ä½œç¬¦çš„ç»„åˆä½¿ç”¨ã€‚</p>

      <div class="tips">
        <h3>æ”¯æŒçš„æŸ¥è¯¢æ“ä½œç¬¦ï¼š</h3>
        <ul>
          <li><strong>eq</strong> - ç­‰äº</li>
          <li><strong>ne</strong> - ä¸ç­‰äº</li>
          <li><strong>gt</strong> - å¤§äº</li>
          <li><strong>gte</strong> - å¤§äºç­‰äº</li>
          <li><strong>lt</strong> - å°äº</li>
          <li><strong>lte</strong> - å°äºç­‰äº</li>
          <li><strong>like</strong> - æ¨¡ç³ŠåŒ¹é…</li>
          <li><strong>in</strong> - åœ¨åˆ—è¡¨ä¸­</li>
          <li><strong>notIn</strong> - ä¸åœ¨åˆ—è¡¨ä¸­</li>
          <li><strong>isNull</strong> - ä¸ºç©º</li>
          <li><strong>isNotNull</strong> - ä¸ä¸ºç©º</li>
        </ul>
      </div>

      <div class="code-example">
        <pre><code>// æŸ¥è¯¢ä»·æ ¼åœ¨ 100-1000 ä¹‹é—´ï¼Œåº“å­˜å¤§äº 10 çš„äº§å“
List&lt;Product&gt; products = productRepository.findBy(
    QueryCriteria.&lt;Product&gt;create()
        .gte("price", 100)
        .lte("price", 1000)
        .gt("stock", 10)
        .orderBy("price", false)  // æŒ‰ä»·æ ¼é™åº
);</code></pre>
      </div>

      <button class="btn btn-primary" onclick="queryProductsByRange()">è¿è¡ŒæŸ¥è¯¢</button>
      <div id="result2" class="result-box" style="display: none;">
        <pre></pre>
      </div>
    </div>

    <div class="demo-section">
      <h2>3. åˆ†é¡µæŸ¥è¯¢</h2>
      <p>ä½¿ç”¨ QueryOptions è¿›è¡Œåˆ†é¡µå’Œæ’åºã€‚</p>

      <div class="code-example">
        <pre><code>// åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·ï¼Œæ¯é¡µ 5 æ¡ï¼ŒæŸ¥è¯¢ç¬¬ 1 é¡µ
QueryOptions options = QueryOptions.create()
    .page(1)
    .pageSize(5)
    .sortBy("createdAt")
    .descending();

PageResult&lt;User&gt; userPage = userRepository.findPage(options);</code></pre>
      </div>

      <button class="btn btn-primary" onclick="queryUsersWithPagination()">è¿è¡Œåˆ†é¡µæŸ¥è¯¢</button>
      <div id="result3" class="result-box" style="display: none;">
        <pre></pre>
      </div>
    </div>

    <div class="demo-section">
      <h2>4. è‡ªå®šä¹‰æŸ¥è¯¢æ„å»ºå™¨</h2>
      <p>å°è¯•æ„å»ºä½ è‡ªå·±çš„æŸ¥è¯¢æ¡ä»¶ã€‚</p>

      <div class="query-builder">
        <div class="query-row">
          <select id="entity">
            <option value="users">ç”¨æˆ·</option>
            <option value="products">äº§å“</option>
          </select>
          <select id="field">
            <option value="">é€‰æ‹©å­—æ®µ</option>
          </select>
          <select id="operator">
            <option value="eq">ç­‰äº</option>
            <option value="ne">ä¸ç­‰äº</option>
            <option value="gt">å¤§äº</option>
            <option value="lt">å°äº</option>
            <option value="like">åŒ…å«</option>
          </select>
          <input type="text" id="value" placeholder="å€¼">
        </div>
        <button class="btn btn-primary" onclick="runCustomQuery()">æ‰§è¡ŒæŸ¥è¯¢</button>
      </div>

      <div id="result4" class="result-box" style="display: none;">
        <pre></pre>
      </div>
    </div>

    <div class="demo-section">
      <h2>5. ç»Ÿè®¡æŸ¥è¯¢</h2>
      <p>å±•ç¤ºå„ç§ç»Ÿè®¡æ•°æ®ã€‚</p>

      <table id="statsTable">
        <thead>
          <tr>
            <th>ç»Ÿè®¡é¡¹</th>
            <th>å€¼</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>æ€»ç”¨æˆ·æ•°</td>
            <td id="stat1">-</td>
          </tr>
          <tr>
            <td>æ´»è·ƒç”¨æˆ·æ•°</td>
            <td id="stat2">-</td>
          </tr>
          <tr>
            <td>ç®¡ç†å‘˜æ•°é‡</td>
            <td id="stat3">-</td>
          </tr>
          <tr>
            <td>æ€»äº§å“æ•°</td>
            <td id="stat4">-</td>
          </tr>
          <tr>
            <td>ä½åº“å­˜äº§å“æ•°</td>
            <td id="stat5">-</td>
          </tr>
          <tr>
            <td>å¹³å‡äº§å“ä»·æ ¼</td>
            <td id="stat6">-</td>
          </tr>
        </tbody>
      </table>

      <button class="btn btn-primary" onclick="loadStatistics()">åŠ è½½ç»Ÿè®¡æ•°æ®</button>
    </div>
  </div>

  <script>
    // å­—æ®µæ˜ å°„
    const fieldMappings = {
      users: [
        { value: 'username', text: 'ç”¨æˆ·å' },
        { value: 'email', text: 'é‚®ç®±' },
        { value: 'role', text: 'è§’è‰²' },
        { value: 'active', text: 'çŠ¶æ€' }
      ],
      products: [
        { value: 'name', text: 'äº§å“åç§°' },
        { value: 'price', text: 'ä»·æ ¼' },
        { value: 'stock', text: 'åº“å­˜' }
      ]
    };

    // å®ä½“é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°å­—æ®µåˆ—è¡¨
    document.getElementById('entity').addEventListener('change', function (e) {
      const fieldSelect = document.getElementById('field');
      const fields = fieldMappings[e.target.value] || [];

      fieldSelect.innerHTML = '<option value="">é€‰æ‹©å­—æ®µ</option>';
      fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field.value;
        option.textContent = field.text;
        fieldSelect.appendChild(option);
      });
    });

    async function queryActiveAdmins() {
      try {
        const response = await fetch('/api/data-example/demo/active-users');
        const result = await response.json();

        const resultBox = document.getElementById('result1');
        const pre = resultBox.querySelector('pre');

        if (result.success) {
          const admins = result.data.filter(u => u.role === 'admin');
          pre.textContent = `æ‰¾åˆ° ${admins.length} ä¸ªæ´»è·ƒçš„ç®¡ç†å‘˜:\n\n`;
          pre.textContent += JSON.stringify(admins, null, 2);
        } else {
          pre.textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
        }

        resultBox.style.display = 'block';
      } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
      }
    }

    async function queryProductsByRange() {
      try {
        const response = await fetch('/api/data-example/products');
        const result = await response.json();

        const resultBox = document.getElementById('result2');
        const pre = resultBox.querySelector('pre');

        if (result.success) {
          // åœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼ˆå®é™…åº”åœ¨æœåŠ¡ç«¯å®ç°ï¼‰
          const filtered = result.data.filter(p =>
            p.price >= 100 && p.price <= 1000 && p.stock > 10
          ).sort((a, b) => b.price - a.price);

          pre.textContent = `æ‰¾åˆ° ${filtered.length} ä¸ªç¬¦åˆæ¡ä»¶çš„äº§å“:\n\n`;
          pre.textContent += JSON.stringify(filtered, null, 2);
        } else {
          pre.textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
        }

        resultBox.style.display = 'block';
      } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
      }
    }

    async function queryUsersWithPagination() {
      try {
        const response = await fetch('/api/data-example/users');
        const result = await response.json();

        const resultBox = document.getElementById('result3');
        const pre = resultBox.querySelector('pre');

        if (result.success) {
          // æ¨¡æ‹Ÿåˆ†é¡µï¼ˆå®é™…åº”åœ¨æœåŠ¡ç«¯å®ç°ï¼‰
          const pageSize = 5;
          const page = 1;
          const start = (page - 1) * pageSize;
          const end = start + pageSize;

          const sorted = result.data.sort((a, b) =>
            new Date(b.createdAt) - new Date(a.createdAt)
          );

          const pageData = sorted.slice(start, end);

          pre.textContent = `åˆ†é¡µç»“æœ (ç¬¬ ${page} é¡µï¼Œæ¯é¡µ ${pageSize} æ¡):\n`;
          pre.textContent += `æ€»è®°å½•æ•°: ${result.data.length}\n`;
          pre.textContent += `æ€»é¡µæ•°: ${Math.ceil(result.data.length / pageSize)}\n\n`;
          pre.textContent += JSON.stringify(pageData, null, 2);
        } else {
          pre.textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
        }

        resultBox.style.display = 'block';
      } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
      }
    }

    async function runCustomQuery() {
      const entity = document.getElementById('entity').value;
      const field = document.getElementById('field').value;
      const operator = document.getElementById('operator').value;
      const value = document.getElementById('value').value;

      if (!field || !value) {
        alert('è¯·é€‰æ‹©å­—æ®µå¹¶è¾“å…¥å€¼');
        return;
      }

      try {
        const endpoint = entity === 'users'
          ? '/api/data-example/users'
          : '/api/data-example/products';

        const response = await fetch(endpoint);
        const result = await response.json();

        const resultBox = document.getElementById('result4');
        const pre = resultBox.querySelector('pre');

        if (result.success) {
          // åœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼ˆå®é™…åº”åœ¨æœåŠ¡ç«¯å®ç°ï¼‰
          let filtered = result.data;

          switch (operator) {
            case 'eq':
              filtered = filtered.filter(item =>
                String(item[field]).toLowerCase() === value.toLowerCase()
              );
              break;
            case 'ne':
              filtered = filtered.filter(item =>
                String(item[field]).toLowerCase() !== value.toLowerCase()
              );
              break;
            case 'gt':
              filtered = filtered.filter(item =>
                Number(item[field]) > Number(value)
              );
              break;
            case 'lt':
              filtered = filtered.filter(item =>
                Number(item[field]) < Number(value)
              );
              break;
            case 'like':
              filtered = filtered.filter(item =>
                String(item[field]).toLowerCase().includes(value.toLowerCase())
              );
              break;
          }

          pre.textContent = `æŸ¥è¯¢ç»“æœ (${filtered.length} æ¡è®°å½•):\n\n`;
          pre.textContent += JSON.stringify(filtered, null, 2);
        } else {
          pre.textContent = `æŸ¥è¯¢å¤±è´¥: ${result.error}`;
        }

        resultBox.style.display = 'block';
      } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
      }
    }

    async function loadStatistics() {
      try {
        // åŠ è½½ç”¨æˆ·æ•°æ®
        const usersResponse = await fetch('/api/data-example/users');
        const usersResult = await usersResponse.json();

        // åŠ è½½äº§å“æ•°æ®
        const productsResponse = await fetch('/api/data-example/products');
        const productsResult = await productsResponse.json();

        if (usersResult.success && productsResult.success) {
          const users = usersResult.data;
          const products = productsResult.data;

          // è®¡ç®—ç»Ÿè®¡æ•°æ®
          document.getElementById('stat1').textContent = users.length;
          document.getElementById('stat2').textContent = users.filter(u => u.active).length;
          document.getElementById('stat3').textContent = users.filter(u => u.role === 'admin').length;
          document.getElementById('stat4').textContent = products.length;
          document.getElementById('stat5').textContent = products.filter(p => p.stock < 20).length;

          const avgPrice = products.length > 0
            ? products.reduce((sum, p) => sum + p.price, 0) / products.length
            : 0;
          document.getElementById('stat6').textContent = 'Â¥' + avgPrice.toFixed(2);
        }
      } catch (error) {
        alert('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message);
      }
    }

    // åˆå§‹åŒ–å­—æ®µåˆ—è¡¨
    document.getElementById('entity').dispatchEvent(new Event('change'));
  </script>
</body>

</html>