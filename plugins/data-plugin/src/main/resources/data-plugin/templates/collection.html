<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{collection}} - æ•°æ®ç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 36px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background-color: #0071e3;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0077ed;
    }

    .btn-secondary {
      background-color: #e8e8ed;
      color: #1d1d1f;
    }

    .btn-secondary:hover {
      background-color: #d2d2d7;
    }

    .data-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #f5f5f7;
    }

    th {
      background-color: #f5f5f7;
      font-weight: 600;
      color: #6e6e73;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background-color: #fafafa;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
    }

    .btn-danger {
      background-color: #ff3b30;
      color: white;
    }

    .btn-danger:hover {
      background-color: #ff453a;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 24px;
    }

    .page-info {
      color: #6e6e73;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6e6e73;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6e6e73;
    }

    .json-value {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 14px;
      color: #007aff;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>{{collection}}</h1>
      <div>
        <a href="/page/data/" class="btn btn-secondary">è¿”å›</a>
        <a href="/page/data/create/{{collection}}" class="btn btn-primary">æ–°å¢æ•°æ®</a>
      </div>
    </div>

    <div class="data-table">
      <div id="tableContent">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <div id="pagination" class="pagination"></div>
  </div>

  <script>
    const collection = '{{collection}}';
    let currentPage = 1;
    const pageSize = 20;

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });

    async function loadData(page = 1) {
      currentPage = page;
      const tableContent = document.getElementById('tableContent');

      try {
        const response = await fetch(`/api/data/${collection}?page=${page}&pageSize=${pageSize}`);
        const result = await response.json();

        if (result.success) {
          displayData(result.data);
          updatePagination(result);
        } else {
          tableContent.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
        }

      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        tableContent.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
      }
    }

    function displayData(data) {
      const tableContent = document.getElementById('tableContent');

      if (data.length === 0) {
        tableContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <h3>æš‚æ— æ•°æ®</h3>
                        <p>ç‚¹å‡»"æ–°å¢æ•°æ®"æŒ‰é’®åˆ›å»ºç¬¬ä¸€æ¡è®°å½•</p>
                    </div>
                `;
        return;
      }

      // è·å–æ‰€æœ‰å­—æ®µå
      const fields = new Set();
      data.forEach(item => {
        Object.keys(item).forEach(key => fields.add(key));
      });
      const fieldArray = Array.from(fields);

      // åˆ›å»ºè¡¨æ ¼
      let tableHTML = '<table><thead><tr>';
      fieldArray.forEach(field => {
        tableHTML += `<th>${field}</th>`;
      });
      tableHTML += '<th>æ“ä½œ</th></tr></thead><tbody>';

      // æ·»åŠ æ•°æ®è¡Œ
      data.forEach(item => {
        tableHTML += '<tr>';
        fieldArray.forEach(field => {
          const value = item[field];
          let displayValue = '';

          if (value === null || value === undefined) {
            displayValue = '<span style="color: #c7c7cc;">null</span>';
          } else if (typeof value === 'object') {
            displayValue = `<span class="json-value">${JSON.stringify(value)}</span>`;
          } else {
            displayValue = String(value);
          }

          tableHTML += `<td>${displayValue}</td>`;
        });

        tableHTML += `
                    <td>
                        <div class="actions">
                            <a href="/page/data/edit/${collection}/${item.id}" class="btn btn-small btn-secondary">ç¼–è¾‘</a>
                            <button onclick="deleteData('${item.id}')" class="btn btn-small btn-danger">åˆ é™¤</button>
                        </div>
                    </td>
                `;
        tableHTML += '</tr>';
      });

      tableHTML += '</tbody></table>';
      tableContent.innerHTML = tableHTML;
    }

    function updatePagination(result) {
      const pagination = document.getElementById('pagination');

      let paginationHTML = '';

      if (result.totalPages > 1) {
        // ä¸Šä¸€é¡µæŒ‰é’®
        if (currentPage > 1) {
          paginationHTML += `<button onclick="loadData(${currentPage - 1})" class="btn btn-secondary">ä¸Šä¸€é¡µ</button>`;
        } else {
          paginationHTML += `<button class="btn btn-secondary" disabled style="opacity: 0.5;">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç ä¿¡æ¯
        paginationHTML += `<span class="page-info">ç¬¬ ${result.page} é¡µï¼Œå…± ${result.totalPages} é¡µï¼ˆ${result.total} æ¡è®°å½•ï¼‰</span>`;

        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (currentPage < result.totalPages) {
          paginationHTML += `<button onclick="loadData(${currentPage + 1})" class="btn btn-secondary">ä¸‹ä¸€é¡µ</button>`;
        } else {
          paginationHTML += `<button class="btn btn-secondary" disabled style="opacity: 0.5;">ä¸‹ä¸€é¡µ</button>`;
        }
      } else {
        paginationHTML = `<span class="page-info">å…± ${result.total} æ¡è®°å½•</span>`;
      }

      pagination.innerHTML = paginationHTML;
    }

    async function deleteData(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ•°æ®å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`/api/data/${collection}/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('åˆ é™¤æˆåŠŸ');
          loadData(currentPage);
        } else {
          const error = await response.json();
          alert('åˆ é™¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
        }

      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
  </script>
</body>

</html>