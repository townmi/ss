<div class="auth-page-container">
  <div class="register-container">
    <div class="register-header">
      <h1>ğŸš€ åˆ›å»ºè´¦æˆ·</h1>
      <p>åŠ å…¥ Work Anywayï¼Œå¼€å¯é«˜æ•ˆå·¥ä½œä¹‹æ—…</p>
    </div>
    
    <form id="registerForm" class="register-form">
      <div class="step-indicator">
        <div class="step active" data-step="1">
          <span class="step-number">1</span>
          <span class="step-label">åŸºæœ¬ä¿¡æ¯</span>
        </div>
        <div class="step" data-step="2">
          <span class="step-number">2</span>
          <span class="step-label">å®‰å…¨è®¾ç½®</span>
        </div>
        <div class="step" data-step="3">
          <span class="step-number">3</span>
          <span class="step-label">å®Œæˆæ³¨å†Œ</span>
        </div>
      </div>
      
      <!-- Step 1: åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-step active" id="step1">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
            required
            pattern="[a-zA-Z0-9_-]{3,20}"
            title="ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿ï¼Œé•¿åº¦3-20ä½"
          >
          <div class="field-hint">ç”¨æˆ·åå°†ä½œä¸ºæ‚¨çš„å”¯ä¸€æ ‡è¯†</div>
        </div>
        
        <div class="form-group">
          <label for="email">é‚®ç®±åœ°å€</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
            required
          >
          <div class="field-hint">æˆ‘ä»¬å°†å‘æ­¤é‚®ç®±å‘é€éªŒè¯é‚®ä»¶</div>
        </div>
        
        <div class="form-group">
          <label for="phone">æ‰‹æœºå·ç ï¼ˆå¯é€‰ï¼‰</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç "
            pattern="[0-9]{11}"
          >
        </div>
        
        <button type="button" class="submit-btn" onclick="nextStep()">
          ä¸‹ä¸€æ­¥
        </button>
      </div>
      
      <!-- Step 2: å®‰å…¨è®¾ç½® -->
      <div class="form-step" id="step2">
        <div class="form-group">
          <label for="password">è®¾ç½®å¯†ç </label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="è¯·è¾“å…¥å¯†ç "
            required
            minlength="8"
          >
          <div class="password-strength">
            <div class="strength-bar">
              <div class="strength-level" id="strengthLevel"></div>
            </div>
            <span class="strength-text" id="strengthText">å¯†ç å¼ºåº¦</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
            required
          >
        </div>
        
        <div class="password-requirements">
          <h4>å¯†ç è¦æ±‚ï¼š</h4>
          <ul>
            <li id="req-length">è‡³å°‘8ä¸ªå­—ç¬¦</li>
            <li id="req-upper">åŒ…å«å¤§å†™å­—æ¯</li>
            <li id="req-lower">åŒ…å«å°å†™å­—æ¯</li>
            <li id="req-number">åŒ…å«æ•°å­—</li>
          </ul>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="prevStep()">
            ä¸Šä¸€æ­¥
          </button>
          <button type="button" class="submit-btn" onclick="nextStep()">
            ä¸‹ä¸€æ­¥
          </button>
        </div>
      </div>
      
      <!-- Step 3: å®Œæˆæ³¨å†Œ -->
      <div class="form-step" id="step3">
        <div class="form-group">
          <label for="verificationCode">é‚®ç®±éªŒè¯ç </label>
          <div class="verification-group">
            <input 
              type="text" 
              id="verificationCode" 
              name="verificationCode" 
              placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç "
              maxlength="6"
              pattern="[0-9]{6}"
              required
            >
            <button type="button" class="btn-send-code" id="sendCodeBtn" onclick="sendVerificationCode()">
              å‘é€éªŒè¯ç 
            </button>
          </div>
        </div>
        
        <div class="terms-group">
          <label>
            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
            æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="/terms" target="_blank">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="/privacy" target="_blank">éšç§æ”¿ç­–</a>
          </label>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="prevStep()">
            ä¸Šä¸€æ­¥
          </button>
          <button type="submit" class="submit-btn" id="submitBtn">
            <span class="btn-text">å®Œæˆæ³¨å†Œ</span>
            <span class="btn-loading" style="display: none;">
              <span class="spinner"></span>
              æ³¨å†Œä¸­...
            </span>
          </button>
        </div>
      </div>
      
      <div class="login-link">
        å·²æœ‰è´¦æˆ·ï¼Ÿ<a href="/auth/login">ç«‹å³ç™»å½•</a>
      </div>
    </form>
  </div>
</div>

<script>
let currentStep = 1;
let verificationTimer = null;

function nextStep() {
  if (validateStep(currentStep)) {
    document.querySelector(`#step${currentStep}`).classList.remove('active');
    document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
    currentStep++;
    document.querySelector(`#step${currentStep}`).classList.add('active');
    document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
  }
}

function prevStep() {
  document.querySelector(`#step${currentStep}`).classList.remove('active');
  document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
  currentStep--;
  document.querySelector(`#step${currentStep}`).classList.add('active');
  document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
}

function validateStep(step) {
  switch(step) {
    case 1:
      const username = document.getElementById('username').value;
      const email = document.getElementById('email').value;
      
      if (!username || username.length < 3) {
        showFieldError('username', 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
        return false;
      }
      
      if (!email || !isValidEmail(email)) {
        showFieldError('email', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
        return false;
      }
      
      return true;
      
    case 2:
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!password || password.length < 8) {
        showFieldError('password', 'å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦');
        return false;
      }
      
      if (password !== confirmPassword) {
        showFieldError('confirmPassword', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return false;
      }
      
      return true;
      
    default:
      return true;
  }
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function showFieldError(fieldId, message) {
  const field = document.getElementById(fieldId);
  field.classList.add('error');
  // å¯ä»¥æ·»åŠ é”™è¯¯æç¤ºé€»è¾‘
}

// å¯†ç å¼ºåº¦æ£€æµ‹
document.getElementById('password').addEventListener('input', function(e) {
  const password = e.target.value;
  const strength = calculatePasswordStrength(password);
  updatePasswordStrength(strength);
  updatePasswordRequirements(password);
});

function calculatePasswordStrength(password) {
  let strength = 0;
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  return strength;
}

function updatePasswordStrength(strength) {
  const strengthLevel = document.getElementById('strengthLevel');
  const strengthText = document.getElementById('strengthText');
  const strengthPercentage = (strength / 6) * 100;
  
  strengthLevel.style.width = strengthPercentage + '%';
  
  if (strength <= 2) {
    strengthLevel.style.backgroundColor = '#ef4444';
    strengthText.textContent = 'å¼±';
  } else if (strength <= 4) {
    strengthLevel.style.backgroundColor = '#f59e0b';
    strengthText.textContent = 'ä¸­';
  } else {
    strengthLevel.style.backgroundColor = '#10b981';
    strengthText.textContent = 'å¼º';
  }
}

function updatePasswordRequirements(password) {
  document.getElementById('req-length').className = password.length >= 8 ? 'met' : '';
  document.getElementById('req-upper').className = /[A-Z]/.test(password) ? 'met' : '';
  document.getElementById('req-lower').className = /[a-z]/.test(password) ? 'met' : '';
  document.getElementById('req-number').className = /[0-9]/.test(password) ? 'met' : '';
}

// å‘é€éªŒè¯ç 
function sendVerificationCode() {
  const email = document.getElementById('email').value;
  const sendCodeBtn = document.getElementById('sendCodeBtn');
  
  if (!email) {
    alert('è¯·å…ˆå¡«å†™é‚®ç®±åœ°å€');
    return;
  }
  
  sendCodeBtn.disabled = true;
  let countdown = 60;
  
  // å‘é€éªŒè¯ç è¯·æ±‚
  fetch('/auth/send-verification-code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email: email, type: 'register' })
  }).then(response => response.json())
    .then(result => {
      if (result.success) {
        // å¼€å§‹å€’è®¡æ—¶
        verificationTimer = setInterval(() => {
          countdown--;
          sendCodeBtn.textContent = `${countdown}ç§’åé‡è¯•`;
          
          if (countdown <= 0) {
            clearInterval(verificationTimer);
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
          }
        }, 1000);
      } else {
        sendCodeBtn.disabled = false;
        alert(result.error || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    })
    .catch(error => {
      sendCodeBtn.disabled = false;
      alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// è¡¨å•æäº¤
document.getElementById('registerForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!document.getElementById('agreeTerms').checked) {
    alert('è¯·åŒæ„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–');
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnLoading = submitBtn.querySelector('.btn-loading');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  submitBtn.disabled = true;
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline-flex';
  errorMessage.style.display = 'none';
  successMessage.style.display = 'none';
  
  const formData = {
    username: document.getElementById('username').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    password: document.getElementById('password').value,
    verificationCode: document.getElementById('verificationCode').value
  };
  
  try {
    const response = await fetch('/auth/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      successMessage.textContent = 'æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...';
      successMessage.style.display = 'block';
      
      setTimeout(() => {
        window.location.href = '/auth/login';
      }, 2000);
    } else {
      errorMessage.textContent = result.error || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
      errorMessage.style.display = 'block';
    }
  } catch (error) {
    errorMessage.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    errorMessage.style.display = 'block';
  } finally {
    submitBtn.disabled = false;
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
  }
});
</script> 