<div class="page-header">
    <h1>ğŸ”‘ æƒé™ç®¡ç†</h1>
    <p>ç®¡ç†ç³»ç»Ÿæƒé™å®šä¹‰å’Œåˆ†é…</p>
</div>

<div class="section">
    <div class="section-header">
        <h2 class="section-title">ç³»ç»Ÿæƒé™åˆ—è¡¨ ({{availablePermissions.length}})</h2>
        <div class="section-actions">
            <button class="btn btn-primary" onclick="showAddPermissionDialog()">
                <span class="btn-icon">â•</span> æ·»åŠ æƒé™
            </button>
            <button class="btn btn-secondary" onclick="refreshPermissions()">
                <span class="btn-icon">ğŸ”„</span> åˆ·æ–°
            </button>
        </div>
    </div>
    
    <div class="permission-grid">
        {{#availablePermissions}}
        <div class="permission-card {{^isActive}}inactive{{/isActive}}">
            <div class="permission-header">
                <div class="permission-icon">ğŸ”</div>
                <div class="permission-info">
                    <h3 class="permission-code">{{code}}</h3>
                    <p class="permission-name">{{name}}</p>
                </div>
            </div>
            {{#description}}
            <p class="permission-description">{{description}}</p>
            {{/description}}
            {{#pluginName}}
            <div class="permission-meta">
                <span class="meta-label">æ’ä»¶ï¼š</span>
                <span class="meta-value">{{pluginName}}</span>
            </div>
            {{/pluginName}}
            <div class="permission-actions">
                <button class="btn btn-sm btn-primary" onclick="editPermission('{{code}}')">
                    ç¼–è¾‘
                </button>
                <button class="btn btn-sm btn-secondary" onclick="viewUsers('{{code}}')">
                    æŸ¥çœ‹ç”¨æˆ·
                </button>
                {{^isActive}}
                <span class="status-badge inactive">å·²ç¦ç”¨</span>
                {{/isActive}}
            </div>
        </div>
        {{/availablePermissions}}
        {{^availablePermissions}}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>æš‚æ— æƒé™æ•°æ®</p>
            <p class="empty-hint">ç³»ç»Ÿæƒé™å°†åœ¨æ’ä»¶åŠ è½½æ—¶è‡ªåŠ¨æ³¨å†Œ</p>
        </div>
        {{/availablePermissions}}
    </div>
</div>

<div class="section">
    <h2 class="section-title">æƒé™åˆ†é…</h2>
    
    <div class="assignment-form">
        <div class="form-row">
            <div class="form-group">
                <label>é€‰æ‹©ç”¨æˆ·</label>
                <input type="text" id="userSearch" placeholder="è¾“å…¥ç”¨æˆ·IDæˆ–é‚®ç®±æœç´¢..." class="form-input">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©æƒé™</label>
                <select id="permissionSelect" class="form-select" multiple size="5">
                    {{#availablePermissions}}
                    <option value="{{code}}">{{name}} ({{code}})</option>
                    {{/availablePermissions}}
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="assignPermissions()">
                    <span class="btn-icon">âœ…</span> åˆ†é…æƒé™
                </button>
            </div>
        </div>
    </div>
</div>

<div class="section">
    <h2 class="section-title">æ‰¹é‡æ“ä½œ</h2>
    
    <div class="batch-operations">
        <div class="operation-card">
            <h3>è§’è‰²æƒé™åˆ†é…</h3>
            <p>ä¸ºè§’è‰²æ‰¹é‡åˆ†é…æƒé™</p>
            <button class="btn btn-secondary" onclick="showRoleAssignment()">
                <span class="btn-icon">ğŸ‘¥</span> ç®¡ç†è§’è‰²æƒé™
            </button>
        </div>
        
        <div class="operation-card">
            <h3>æƒé™å¯¼å…¥å¯¼å‡º</h3>
            <p>æ‰¹é‡å¯¼å…¥æˆ–å¯¼å‡ºæƒé™å®šä¹‰</p>
            <button class="btn btn-secondary" onclick="exportPermissions()">
                <span class="btn-icon">ğŸ“¤</span> å¯¼å‡º
            </button>
            <button class="btn btn-secondary" onclick="importPermissions()">
                <span class="btn-icon">ğŸ“¥</span> å¯¼å…¥
            </button>
        </div>
        
        <div class="operation-card">
            <h3>æƒé™å®¡è®¡</h3>
            <p>æŸ¥çœ‹æƒé™åˆ†é…å†å²è®°å½•</p>
            <button class="btn btn-secondary" onclick="viewAuditLog()">
                <span class="btn-icon">ğŸ“‹</span> æŸ¥çœ‹æ—¥å¿—
            </button>
        </div>
    </div>
</div>

<!-- æ·»åŠ æƒé™å¯¹è¯æ¡† -->
<div id="addPermissionDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æ·»åŠ æƒé™</h2>
            <span class="close" onclick="closeAddPermissionDialog()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>æƒé™ä»£ç </label>
                <input type="text" id="newPermissionCode" class="form-input" placeholder="ä¾‹å¦‚: user.create">
            </div>
            <div class="form-group">
                <label>æƒé™åç§°</label>
                <input type="text" id="newPermissionName" class="form-input" placeholder="ä¾‹å¦‚: åˆ›å»ºç”¨æˆ·">
            </div>
            <div class="form-group">
                <label>æƒé™æè¿°</label>
                <textarea id="newPermissionDesc" class="form-input" rows="3" placeholder="è¯¦ç»†æè¿°æ­¤æƒé™çš„ä½œç”¨..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="createPermission()">åˆ›å»º</button>
            <button class="btn btn-secondary" onclick="closeAddPermissionDialog()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<style>
/* æƒé™ç®¡ç†é¡µé¢ç‰¹å®šæ ·å¼ */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-actions {
    display: flex;
    gap: 10px;
}

.assignment-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 20px;
    align-items: end;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
}

.form-actions {
    display: flex;
    align-items: flex-end;
}

.batch-operations {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.operation-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.operation-card h3 {
    color: #333;
    margin-bottom: 10px;
}

.operation-card p {
    color: #6c757d;
    margin-bottom: 15px;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.modal-header h2 {
    margin: 0;
    color: #333;
}

.close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
</style>

<script>
// æƒé™ç®¡ç†åŠŸèƒ½
function editPermission(code) {
    // TODO: å®ç°ç¼–è¾‘æƒé™åŠŸèƒ½
    alert('ç¼–è¾‘æƒé™: ' + code);
}

function viewUsers(code) {
    // è·³è½¬åˆ°æŸ¥çœ‹æ‹¥æœ‰è¯¥æƒé™çš„ç”¨æˆ·åˆ—è¡¨
    window.location.href = `/auth/permissions/users?permission=${encodeURIComponent(code)}`;
}

function showAddPermissionDialog() {
    document.getElementById('addPermissionDialog').style.display = 'flex';
}

function closeAddPermissionDialog() {
    document.getElementById('addPermissionDialog').style.display = 'none';
    // æ¸…ç©ºè¡¨å•
    document.getElementById('newPermissionCode').value = '';
    document.getElementById('newPermissionName').value = '';
    document.getElementById('newPermissionDesc').value = '';
}

function createPermission() {
    const code = document.getElementById('newPermissionCode').value;
    const name = document.getElementById('newPermissionName').value;
    const description = document.getElementById('newPermissionDesc').value;
    
    if (!code || !name) {
        alert('æƒé™ä»£ç å’Œåç§°æ˜¯å¿…å¡«é¡¹ï¼');
        return;
    }
    
    // TODO: è°ƒç”¨APIåˆ›å»ºæƒé™
    fetch('/auth/permissions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ code, name, description })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('æƒé™åˆ›å»ºæˆåŠŸï¼');
            closeAddPermissionDialog();
            refreshPermissions();
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    });
}

function refreshPermissions() {
    window.location.reload();
}

function assignPermissions() {
    const userId = document.getElementById('userSearch').value;
    const selectedOptions = document.getElementById('permissionSelect').selectedOptions;
    const permissions = Array.from(selectedOptions).map(opt => opt.value);
    
    if (!userId || permissions.length === 0) {
        alert('è¯·é€‰æ‹©ç”¨æˆ·å’Œè‡³å°‘ä¸€ä¸ªæƒé™ï¼');
        return;
    }
    
    // TODO: è°ƒç”¨APIåˆ†é…æƒé™
    fetch(`/auth/permissions/${userId}/batch`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ permissions })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('æƒé™åˆ†é…æˆåŠŸï¼');
            document.getElementById('userSearch').value = '';
            document.getElementById('permissionSelect').selectedIndex = -1;
        } else {
            alert('åˆ†é…å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    });
}

function showRoleAssignment() {
    // TODO: å®ç°è§’è‰²æƒé™åˆ†é…ç•Œé¢
    alert('è§’è‰²æƒé™åˆ†é…åŠŸèƒ½å¼€å‘ä¸­...');
}

function exportPermissions() {
    // TODO: å®ç°æƒé™å¯¼å‡ºåŠŸèƒ½
    window.location.href = '/auth/permissions/export';
}

function importPermissions() {
    // TODO: å®ç°æƒé™å¯¼å…¥åŠŸèƒ½
    alert('æƒé™å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­...');
}

function viewAuditLog() {
    // è·³è½¬åˆ°æƒé™å®¡è®¡æ—¥å¿—é¡µé¢
    window.location.href = '/auth/permissions/audit';
}
</script> 