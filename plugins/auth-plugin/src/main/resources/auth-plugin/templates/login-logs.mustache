<div class="page-header">
    <h1>ğŸ“‹ ç™»å½•æ—¥å¿—</h1>
    <p>æŸ¥çœ‹ç³»ç»Ÿç™»å½•å†å²è®°å½•å’Œå®‰å…¨äº‹ä»¶</p>
</div>

<div class="filter-section">
    <h3>ç­›é€‰æ¡ä»¶</h3>
    <div class="filter-row">
        <div class="filter-group">
            <label>æ—¶é—´èŒƒå›´</label>
            <select id="timeRange" onchange="applyFilters()">
                <option value="24">è¿‡å» 24 å°æ—¶</option>
                <option value="48">è¿‡å» 48 å°æ—¶</option>
                <option value="168">è¿‡å» 7 å¤©</option>
                <option value="720">è¿‡å» 30 å¤©</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>çŠ¶æ€</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">å…¨éƒ¨</option>
                <option value="success">æˆåŠŸ</option>
                <option value="failed">å¤±è´¥</option>
                <option value="blocked">è¢«é˜»æ­¢</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>ç”¨æˆ·æ ‡è¯†</label>
            <input type="text" id="userFilter" placeholder="ç”¨æˆ·åæˆ–é‚®ç®±" onkeyup="debounceFilter()">
        </div>
        
        <div class="filter-group">
            <label>IP åœ°å€</label>
            <input type="text" id="ipFilter" placeholder="IP åœ°å€" onkeyup="debounceFilter()">
        </div>
        
        <div class="filter-group" style="align-self: flex-end;">
            <button class="btn btn-primary" onclick="applyFilters()">
                <span class="btn-icon">ğŸ”</span> æœç´¢
            </button>
            <button class="btn btn-secondary" onclick="resetFilters()">
                <span class="btn-icon">ğŸ”„</span> é‡ç½®
            </button>
        </div>
    </div>
</div>

<div class="section">
    <div id="logsContainer">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½ç™»å½•æ—¥å¿—...</p>
        </div>
    </div>
</div>

<style>
/* é¡µé¢ç‰¹å®šæ ·å¼ */
.loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.loading-spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.log-entry {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.log-entry:hover {
    background-color: #f8f9fa;
}

.log-time {
    width: 180px;
    color: #6c757d;
    font-size: 0.9rem;
}

.log-user {
    flex: 1;
    font-weight: 500;
}

.log-ip {
    width: 150px;
    font-family: monospace;
    color: #495057;
}

.log-details {
    flex: 1;
    color: #6c757d;
    font-size: 0.9rem;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.pagination button {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.pagination button:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #667eea;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    color: #6c757d;
}
</style>

<script>
let currentPage = 1;
let filterTimer = null;

// é¡µé¢åŠ è½½æ—¶è·å–æ—¥å¿—
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
});

function loadLogs(page = 1) {
    currentPage = page;
    const container = document.getElementById('logsContainer');
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>æ­£åœ¨åŠ è½½ç™»å½•æ—¥å¿—...</p></div>';
    
    const params = new URLSearchParams({
        page: page,
        limit: 20,
        hours: document.getElementById('timeRange').value,
        status: document.getElementById('statusFilter').value,
        identifier: document.getElementById('userFilter').value,
        clientIp: document.getElementById('ipFilter').value
    });
    
    fetch(`/auth/logs?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderLogs(data.data);
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><p>åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</p></div>';
            }
        })
        .catch(error => {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><p>ç½‘ç»œé”™è¯¯ï¼š' + error.message + '</p></div>';
        });
}

function renderLogs(data) {
    const container = document.getElementById('logsContainer');
    
    if (!data.logs || data.logs.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>æš‚æ— ç™»å½•æ—¥å¿—</p></div>';
        return;
    }
    
    let html = '<table class="log-table"><thead><tr>';
    html += '<th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>IPåœ°å€</th><th>çŠ¶æ€</th><th>è¯¦æƒ…</th>';
    html += '</tr></thead><tbody>';
    
    data.logs.forEach(log => {
        html += '<tr class="log-entry">';
        html += `<td class="log-time">${formatTime(log.createdAt)}</td>`;
        html += `<td class="log-user">${log.identifier}</td>`;
        html += `<td class="log-ip">${log.clientIp}</td>`;
        html += `<td><span class="log-status ${log.loginStatus}">${getStatusText(log.loginStatus)}</span></td>`;
        html += `<td class="log-details">${log.failureReason || '-'}</td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    
    // åˆ†é¡µ
    if (data.total > data.limit) {
        const totalPages = Math.ceil(data.total / data.limit);
        html += '<div class="pagination">';
        html += `<button onclick="loadLogs(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é¡µ</button>`;
        html += `<button onclick="loadLogs(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
        html += `<span class="pagination-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>`;
        html += `<button onclick="loadLogs(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
        html += `<button onclick="loadLogs(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é¡µ</button>`;
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN');
}

function getStatusText(status) {
    const statusMap = {
        'success': 'æˆåŠŸ',
        'failed': 'å¤±è´¥',
        'blocked': 'è¢«é˜»æ­¢'
    };
    return statusMap[status] || status;
}

function applyFilters() {
    loadLogs(1);
}

function resetFilters() {
    document.getElementById('timeRange').value = '24';
    document.getElementById('statusFilter').value = '';
    document.getElementById('userFilter').value = '';
    document.getElementById('ipFilter').value = '';
    loadLogs(1);
}

function debounceFilter() {
    clearTimeout(filterTimer);
    filterTimer = setTimeout(() => {
        applyFilters();
    }, 500);
}
</script> 