<div class="page-header">
    <h1>⚙️ 认证设置</h1>
    <p>配置系统认证和安全策略</p>
</div>

<div class="settings-container">
    <div class="settings-nav">
        <h3>设置分类</h3>
        <ul class="settings-menu">
            <li><a href="#basic-settings" class="active">基本设置</a></li>
            <li><a href="#security-settings">安全策略</a></li>
            <li><a href="#password-settings">密码规则</a></li>
            <li><a href="#session-settings">会话管理</a></li>
            <li><a href="#notification-settings">通知设置</a></li>
        </ul>
    </div>

    <div class="settings-content">
        <!-- 基本设置 -->
        <section id="basic-settings" class="settings-section active">
            <h2 class="section-title">基本设置</h2>
            
            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">启用用户注册</span>
                    <span class="label-desc">允许新用户自行注册账号</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="enableRegistration" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">需要邮箱验证</span>
                    <span class="label-desc">新用户注册后必须验证邮箱才能登录</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="requireEmailVerification">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">默认用户角色</span>
                    <span class="label-desc">新注册用户的默认角色</span>
                </label>
                <div class="setting-control">
                    <select id="defaultRole" class="form-select">
                        <option value="user">普通用户</option>
                        <option value="member">会员</option>
                        <option value="guest">访客</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- 安全策略 -->
        <section id="security-settings" class="settings-section">
            <h2 class="section-title">安全策略</h2>
            
            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">登录失败次数限制</span>
                    <span class="label-desc">连续失败后锁定账号</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="maxLoginAttempts" class="form-input" value="5" min="3" max="10">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">账号锁定时长（分钟）</span>
                    <span class="label-desc">账号被锁定后的解锁时间</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="lockoutDuration" class="form-input" value="30" min="5" max="1440">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">启用 IP 黑名单</span>
                    <span class="label-desc">自动封禁恶意 IP 地址</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="enableIpBlacklist" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">双因素认证</span>
                    <span class="label-desc">要求用户启用双因素认证</span>
                </label>
                <div class="setting-control">
                    <select id="twoFactorAuth" class="form-select">
                        <option value="optional">可选</option>
                        <option value="required">必需</option>
                        <option value="disabled">禁用</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- 密码规则 -->
        <section id="password-settings" class="settings-section">
            <h2 class="section-title">密码规则</h2>
            
            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">最小密码长度</span>
                    <span class="label-desc">密码的最少字符数</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="minPasswordLength" class="form-input" value="8" min="6" max="32">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">需要大写字母</span>
                    <span class="label-desc">密码必须包含至少一个大写字母</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="requireUppercase" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">需要数字</span>
                    <span class="label-desc">密码必须包含至少一个数字</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="requireNumbers" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">需要特殊字符</span>
                    <span class="label-desc">密码必须包含至少一个特殊字符</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="requireSpecialChars">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">密码过期天数</span>
                    <span class="label-desc">密码必须定期更换（0 表示永不过期）</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="passwordExpireDays" class="form-input" value="0" min="0" max="365">
                </div>
            </div>
        </section>

        <!-- 会话管理 -->
        <section id="session-settings" class="settings-section">
            <h2 class="section-title">会话管理</h2>
            
            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">会话超时（分钟）</span>
                    <span class="label-desc">用户无活动后自动登出</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="sessionTimeout" class="form-input" value="60" min="5" max="1440">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">记住登录天数</span>
                    <span class="label-desc">"记住我"功能的有效期</span>
                </label>
                <div class="setting-control">
                    <input type="number" id="rememberMeDays" class="form-input" value="30" min="1" max="90">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">单设备登录</span>
                    <span class="label-desc">同一账号只能在一个设备上登录</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="singleDeviceLogin">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>

        <!-- 通知设置 -->
        <section id="notification-settings" class="settings-section">
            <h2 class="section-title">通知设置</h2>
            
            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">登录通知</span>
                    <span class="label-desc">新设备登录时发送邮件通知</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="loginNotification" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">异常活动通知</span>
                    <span class="label-desc">检测到异常活动时通知用户</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="anomalyNotification" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    <span class="label-text">密码修改通知</span>
                    <span class="label-desc">密码被修改时发送确认邮件</span>
                </label>
                <div class="setting-control">
                    <label class="switch">
                        <input type="checkbox" id="passwordChangeNotification" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>

        <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveSettings()">
                <span class="btn-icon">💾</span> 保存设置
            </button>
            <button class="btn btn-secondary" onclick="resetSettings()">
                <span class="btn-icon">↩️</span> 恢复默认
            </button>
        </div>
    </div>
</div>

<script>
// 设置导航切换
document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.settings-menu a');
    const sections = document.querySelectorAll('.settings-section');
    
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            
            // 更新菜单状态
            menuItems.forEach(mi => mi.classList.remove('active'));
            this.classList.add('active');
            
            // 显示对应部分
            sections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        });
    });
});

// 保存设置
function saveSettings() {
    const settings = {
        basic: {
            enableRegistration: document.getElementById('enableRegistration').checked,
            requireEmailVerification: document.getElementById('requireEmailVerification').checked,
            defaultRole: document.getElementById('defaultRole').value
        },
        security: {
            maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value),
            lockoutDuration: parseInt(document.getElementById('lockoutDuration').value),
            enableIpBlacklist: document.getElementById('enableIpBlacklist').checked,
            twoFactorAuth: document.getElementById('twoFactorAuth').value
        },
        password: {
            minPasswordLength: parseInt(document.getElementById('minPasswordLength').value),
            requireUppercase: document.getElementById('requireUppercase').checked,
            requireNumbers: document.getElementById('requireNumbers').checked,
            requireSpecialChars: document.getElementById('requireSpecialChars').checked,
            passwordExpireDays: parseInt(document.getElementById('passwordExpireDays').value)
        },
        session: {
            sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
            rememberMeDays: parseInt(document.getElementById('rememberMeDays').value),
            singleDeviceLogin: document.getElementById('singleDeviceLogin').checked
        },
        notification: {
            loginNotification: document.getElementById('loginNotification').checked,
            anomalyNotification: document.getElementById('anomalyNotification').checked,
            passwordChangeNotification: document.getElementById('passwordChangeNotification').checked
        }
    };
    
    // 发送保存请求
    fetch('/auth/settings', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('设置保存成功！');
        } else {
            alert('保存失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        alert('请求失败：' + error.message);
    });
}

// 恢复默认设置
function resetSettings() {
    if (confirm('确定要恢复默认设置吗？')) {
        // 恢复各项设置的默认值
        document.getElementById('enableRegistration').checked = true;
        document.getElementById('requireEmailVerification').checked = false;
        document.getElementById('defaultRole').value = 'user';
        
        document.getElementById('maxLoginAttempts').value = '5';
        document.getElementById('lockoutDuration').value = '30';
        document.getElementById('enableIpBlacklist').checked = true;
        document.getElementById('twoFactorAuth').value = 'optional';
        
        document.getElementById('minPasswordLength').value = '8';
        document.getElementById('requireUppercase').checked = true;
        document.getElementById('requireNumbers').checked = true;
        document.getElementById('requireSpecialChars').checked = false;
        document.getElementById('passwordExpireDays').value = '0';
        
        document.getElementById('sessionTimeout').value = '60';
        document.getElementById('rememberMeDays').value = '30';
        document.getElementById('singleDeviceLogin').checked = false;
        
        document.getElementById('loginNotification').checked = true;
        document.getElementById('anomalyNotification').checked = true;
        document.getElementById('passwordChangeNotification').checked = true;
    }
}
</script> 