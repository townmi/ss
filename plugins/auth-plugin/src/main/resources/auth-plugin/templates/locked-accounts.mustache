<div class="page-header">
    <div>
        <div class="page-title">
            <h1>ğŸ”’ è´¦æˆ·é”å®šç®¡ç†</h1>
        </div>
        <div class="breadcrumb">
            <a href="/auth/">è®¤è¯ç®¡ç†</a> / è´¦æˆ·é”å®šç®¡ç†
        </div>
    </div>
    <button class="btn btn-primary" onclick="showLockModal()">æ‰‹åŠ¨é”å®šè´¦æˆ·</button>
</div>

<div class="stats-summary">
    <div class="summary-card warning">
        <h3>å½“å‰é”å®šè´¦æˆ·</h3>
        <div class="value">{{lockedAccountsCount}}</div>
    </div>
    <div class="summary-card danger">
        <h3>IPé»‘åå•æ•°é‡</h3>
        <div class="value">{{blacklistedIpsCount}}</div>
    </div>
    <div class="summary-card">
        <h3>ä»Šæ—¥è§£é”</h3>
        <div class="value">{{todayUnlockedCount}}</div>
    </div>
</div>

<div class="locked-accounts-table data-table">
    <div class="table-header">
        <h2>é”å®šè´¦æˆ·åˆ—è¡¨</h2>
        <div class="search-box">
            <input type="text" placeholder="æœç´¢è´¦æˆ·..." id="searchInput" onkeyup="filterTable()">
        </div>
    </div>
    
    {{#hasLockedAccounts}}
    <table id="accountsTable">
        <thead>
            <tr>
                <th>è´¦æˆ·æ ‡è¯†</th>
                <th>ç±»å‹</th>
                <th>é”å®šç±»å‹</th>
                <th>é”å®šåŸå› </th>
                <th>å¤±è´¥æ¬¡æ•°</th>
                <th>é”å®šæ—¶é—´</th>
                <th>è§£é”æ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {{#lockedAccounts}}
            <tr>
                <td><strong>{{identifier}}</strong></td>
                <td>{{identifierType}}</td>
                <td><span class="lock-type {{lockTypeClass}}">{{lockType}}</span></td>
                <td>{{lockReason}}</td>
                <td>{{attemptCount}}</td>
                <td>{{lockedAt}}</td>
                <td>{{lockedUntil}}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="unlockAccount('{{identifier}}')">è§£é”</button>
                        <button class="btn btn-primary" onclick="viewDetails('{{identifier}}')">è¯¦æƒ…</button>
                    </div>
                </td>
            </tr>
            {{/lockedAccounts}}
        </tbody>
    </table>
    {{/hasLockedAccounts}}
    
    {{^hasLockedAccounts}}
    <div class="empty-state">
        <div class="icon">ğŸ‰</div>
        <p>å½“å‰æ²¡æœ‰è¢«é”å®šçš„è´¦æˆ·</p>
        <p style="color: #666; font-size: 0.9rem;">ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰è´¦æˆ·éƒ½å¯ä»¥æ­£å¸¸è®¿é—®</p>
    </div>
    {{/hasLockedAccounts}}
</div>

<!-- æ‰‹åŠ¨é”å®šè´¦æˆ·æ¨¡æ€æ¡† -->
<div id="lockModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ‰‹åŠ¨é”å®šè´¦æˆ·</h3>
            <span class="close" onclick="closeLockModal()">&times;</span>
        </div>
        <form id="lockForm">
            <div class="form-group">
                <label>è´¦æˆ·æ ‡è¯†</label>
                <input type="text" name="identifier" required placeholder="é‚®ç®±ã€æ‰‹æœºå·æˆ–ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>é”å®šæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" name="duration" value="15" min="1" max="1440">
            </div>
            <div class="form-group">
                <label>é”å®šåŸå› </label>
                <textarea name="reason" required placeholder="è¯·è¾“å…¥é”å®šåŸå› ..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeLockModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-danger">ç¡®è®¤é”å®š</button>
            </div>
        </form>
    </div>
</div>

<script>
    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('accountsTable');
        const tr = table.getElementsByTagName('tr');
        
        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName('td')[0];
            if (td) {
                const txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
    }
    
    function unlockAccount(identifier) {
        if (confirm(`ç¡®å®šè¦è§£é”è´¦æˆ· ${identifier} å—ï¼Ÿ`)) {
            fetch('/auth/admin/security/unlock-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({ identifier: identifier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è´¦æˆ·å·²æˆåŠŸè§£é”');
                    location.reload();
                } else {
                    alert('è§£é”å¤±è´¥ï¼š' + data.error);
                }
            })
            .catch(error => {
                alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
            });
        }
    }
    
    function viewDetails(identifier) {
        window.location.href = `/auth/admin/security/account/${identifier}`;
    }
    
    function showLockModal() {
        document.getElementById('lockModal').style.display = 'block';
    }
    
    function closeLockModal() {
        document.getElementById('lockModal').style.display = 'none';
        document.getElementById('lockForm').reset();
    }
    
    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('lockForm').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            identifier: formData.get('identifier'),
            durationMinutes: parseInt(formData.get('duration')),
            reason: formData.get('reason')
        };
        
        fetch('/auth/admin/security/lock-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('è´¦æˆ·å·²æˆåŠŸé”å®š');
                closeLockModal();
                location.reload();
            } else {
                alert('é”å®šå¤±è´¥ï¼š' + result.error);
            }
        })
        .catch(error => {
            alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
        });
    };
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('lockModal');
        if (event.target == modal) {
            closeLockModal();
        }
    }
</script> 