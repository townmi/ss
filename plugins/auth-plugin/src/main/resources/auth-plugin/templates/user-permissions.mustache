<div class="page-header">
    <h1>ğŸ‘¤ ç”¨æˆ·æƒé™ç®¡ç†</h1>
    <p>ç®¡ç†ç”¨æˆ· <strong>{{userId}}</strong> çš„æƒé™</p>
</div>

<div class="section">
    <div class="section-header">
        <h2 class="section-title">æƒé™çŠ¶æ€ ({{grantedCount}}/{{totalCount}})</h2>
        <div class="section-actions">
            <button class="btn btn-primary btn-sm" onclick="savePermissions()">
                <span class="btn-icon">ğŸ’¾</span> ä¿å­˜æ›´æ”¹
            </button>
            <button class="btn btn-secondary btn-sm" onclick="resetChanges()">
                <span class="btn-icon">â†©ï¸</span> é‡ç½®
            </button>
        </div>
    </div>
    
    <div class="permissions-list">
        {{#permissions}}
        <div class="permission-item">
            <label class="permission-label">
                <input type="checkbox" 
                       class="permission-checkbox" 
                       value="{{code}}" 
                       data-original="{{granted}}"
                       {{#granted}}checked{{/granted}}>
                <div class="permission-content">
                    <div class="permission-header">
                        <span class="permission-code">{{code}}</span>
                        <span class="permission-name">{{name}}</span>
                    </div>
                    {{#description}}
                    <div class="permission-description">{{description}}</div>
                    {{/description}}
                    {{#pluginName}}
                    <div class="permission-plugin">æ¥æºï¼š{{pluginName}}</div>
                    {{/pluginName}}
                </div>
            </label>
        </div>
        {{/permissions}}
        {{^permissions}}
        <div class="empty-state">
            <div class="empty-icon">ğŸ”’</div>
            <p>æš‚æ— å¯åˆ†é…çš„æƒé™</p>
        </div>
        {{/permissions}}
    </div>
</div>

<div class="section">
    <h2 class="section-title">æ“ä½œè¯´æ˜</h2>
    <div class="info-box">
        <p>âœ… å‹¾é€‰æƒé™ä»¥æˆäºˆç”¨æˆ·ç›¸åº”çš„è®¿é—®æƒé™</p>
        <p>âŒ å–æ¶ˆå‹¾é€‰ä»¥æ’¤é”€ç”¨æˆ·çš„æƒé™</p>
        <p>ğŸ’¾ è®°å¾—ç‚¹å‡»"ä¿å­˜æ›´æ”¹"æŒ‰é’®ä»¥åº”ç”¨ä¿®æ”¹</p>
        <p>ğŸ”„ ä¿®æ”¹åçš„æƒé™ä¼šæ˜¾ç¤ºä¸ºé«˜äº®çŠ¶æ€</p>
    </div>
</div>

<style>
/* ç”¨æˆ·æƒé™ç®¡ç†ç‰¹å®šæ ·å¼ */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-actions {
    display: flex;
    gap: 10px;
}

.permissions-list {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    max-height: 600px;
    overflow-y: auto;
}

.permission-item {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.permission-item:last-child {
    border-bottom: none;
}

.permission-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    transition: background-color 0.2s;
    padding: 10px;
    border-radius: 4px;
    margin: -10px;
}

.permission-label:hover {
    background-color: #f8f9fa;
}

.permission-label.changed {
    background-color: #fff3cd;
}

.permission-checkbox {
    width: 18px;
    height: 18px;
    margin-right: 12px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
}

.permission-content {
    flex: 1;
}

.permission-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.permission-code {
    font-family: monospace;
    font-size: 0.9rem;
    color: #495057;
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
}

.permission-name {
    font-weight: 500;
    color: #333;
}

.permission-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 3px;
}

.permission-plugin {
    font-size: 0.75rem;
    color: #6c757d;
}

.info-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.info-box p {
    margin: 8px 0;
    color: #495057;
}
</style>

<script>
// è¿½è¸ªä¿®æ”¹çš„æƒé™
let changedPermissions = new Set();

// ç›‘å¬æƒé™å¤é€‰æ¡†å˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const original = this.getAttribute('data-original') === 'true';
            const current = this.checked;
            const label = this.closest('.permission-label');
            
            if (original !== current) {
                changedPermissions.add(this.value);
                label.classList.add('changed');
            } else {
                changedPermissions.delete(this.value);
                label.classList.remove('changed');
            }
        });
    });
});

function savePermissions() {
    const userId = '{{userId}}';
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    const permissions = [];
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            permissions.push(checkbox.value);
        }
    });
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="btn-icon">â³</span> ä¿å­˜ä¸­...';
    
    // å‘é€æƒé™æ›´æ–°è¯·æ±‚
    fetch(`/auth/permissions/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ permissions })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°åŸå§‹çŠ¶æ€
            checkboxes.forEach(checkbox => {
                checkbox.setAttribute('data-original', checkbox.checked);
            });
            // æ¸…é™¤ä¿®æ”¹æ ‡è®°
            changedPermissions.clear();
            document.querySelectorAll('.permission-label.changed').forEach(label => {
                label.classList.remove('changed');
            });
            alert('æƒé™æ›´æ–°æˆåŠŸï¼');
        } else {
            alert('æƒé™æ›´æ–°å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}

function resetChanges() {
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    checkboxes.forEach(checkbox => {
        const original = checkbox.getAttribute('data-original') === 'true';
        checkbox.checked = original;
        checkbox.closest('.permission-label').classList.remove('changed');
    });
    changedPermissions.clear();
}
</script> 